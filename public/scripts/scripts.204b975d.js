"use strict";angular.module("ngblogApp",["angular-loading-bar","ngAnimate","ngCookies","ngMessages","ngRoute","ngSanitize","ngTouch","ui.bootstrap","ngTagsInput","angularFileUpload","LocalStorageModule"]).config(["$httpProvider",function(a){a.interceptors.push("SessionInjector")}]).config(["localStorageServiceProvider",function(a){a.setPrefix("ngblogApp").setStorageType("localStorage").setStorageCookie(10,"/").setNotify(!0,!0)}]).run(["$rootScope","$location","SessionService",function(a,b,c){a.$on("$routeChangeStart",function(a,d){console.log(d);var e=["views/admin_new_post.html","views/admin_edit_post.html","views/admin_posts.html","views/admin_index.html"];_.include(e,d.templateUrl)&&(console.log(c.authToken),null===c.authToken&&("views/login.html"===d.templateUrl||(console.log(b.$$path),c.setBackUrl(b.$$path),b.path("/login"))))})}]).config(["$routeProvider","cfpLoadingBarProvider",function(a,b){b.includeSpinner=!1;var c=function(){return!SmartPhone.isAny()}();a.when("/",{templateUrl:c?"views/main.html":"views/mobile/main.html",controller:"MainCtrl"}).when("/posts",{templateUrl:"views/posts.html",controller:"PostsCtrl"}).when("/posts/:postId",{templateUrl:"views/show_post.html",controller:"PostShowCtrl"}).when("/admin/posts",{templateUrl:"views/admin_posts.html",controller:"AdminPostsCtrl",reloadOnSearch:!1}).when("/admin/posts/new",{templateUrl:"views/admin_new_post.html",controller:"PostNewCtrl",reloadOnSearch:!1}).when("/admin/posts/:postId",{templateUrl:"views/admin_edit_post.html",controller:"PostEditCtrl"}).when("/search/posts",{templateUrl:"views/search_posts.html",controller:"SearchPostsCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("ngblogApp").controller("BaseCtrl",["$scope","$window",function(a,b){a.search=function(){b.location.href="/#/search/posts?keyword="+a.keyword}}]),angular.module("ngblogApp").controller("MainCtrl",["$scope","postsService","$http","$controller",function(a,b,c,d){a.posts=[],b.getPosts(1,10,0).success(function(b){a.posts=b.data.posts}).error(function(a){console.log(a)}),a.myInterval=5e3;var e=a.slides=[];a.addSlide=function(){var a=e.length+1;e.push({image:"/images/"+a+".jpg",text:["More","Extra","Lots of","Surplus"][e.length%4]+" "+["Cats","Kittys","Felines","Cutes"][e.length%4]})};for(var f=0;5>f;f++)a.addSlide();d("BaseCtrl",{$scope:a})}]),angular.module("ngblogApp").controller("PostsCtrl",["$scope","$log","postsService","$location","$anchorScroll","$controller",function(a,b,c,d,e,f){a.posts=[],a.itemsPerPage=5,a.bigTotalItems=null,a.bigCurrentPage=1,a.maxSize=8,c.getPosts(a.bigCurrentPage,a.itemsPerPage,0).success(function(b){a.posts=b.data.posts,a.bigTotalItems=b.data.total_count}).error(function(a){console.log(a)}),a.pageChanged=function(){c.getPosts(a.bigCurrentPage,a.itemsPerPage,0).success(function(b){a.posts=b.data.posts}).error(function(a){console.log(a)})},a.scrollTop=function(){e()},f("BaseCtrl",{$scope:a})}]),angular.module("ngblogApp").controller("AdminPostsCtrl",["$scope","$log","postsService","AuthService","$window","adminNavService",function(a,b,c,d,e,f){a.crumbs=[{anchor:"/#admin/posts/new",menu:"添加文章"},{anchor:"/#admin/posts/23/edit",menu:"编辑文章"}],a.navacitves={postsActive:!0,newpostActive:!1,adduserActive:!1,usersActive:!1},a.posts=[],a.itemsPerPage=20,a.bigTotalItems=null,a.bigCurrentPage=1,a.maxSize=8,c.getPosts(a.bigCurrentPage,a.itemsPerPage,0).success(function(b){a.posts=b.data.posts,a.bigTotalItems=b.data.total_count}).error(function(a){console.log(a)}),a.pageChanged=function(){c.getPosts(a.bigCurrentPage,a.itemsPerPage,0).success(function(b){a.posts=b.data.posts}).error(function(a){console.log(a)}),b.log("Page changed to: "+a.bigCurrentPage)},a.delPost=function(b){console.log(this),confirm("确定删除吗")&&c.delPost(b).success(function(c){if("destroied"===c.status){for(var d=a.posts.length-1;d>=0;d--)a.posts[d].id===b&&a.posts.splice(d,1);alert("删除成功")}else alert("删除失败")}).error(function(a){console.log(a)})},a.logout=function(){f.logout()}}]),angular.module("ngblogApp").controller("PostNewCtrl",["$scope","$http","postsService","$location","FileUploader","AuthService","$window","adminNavService",function(a,b,c,d,e,f,g,h){a.crumbs=[{anchor:"/#admin/posts",menu:"所有文章"},{anchor:"/#admin/posts/new",menu:"添加文章"}],a.navacitves={postsActive:!1,newpostActive:!0,adduserActive:!1,usersActive:!1},a.isCollapsed=!0,a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.post={},a.post.markdown="",a.markdown=function(a){return marked.setOptions({highlight:function(a){return hljs.highlightAuto(a).value}}),marked(a)},a.post.img="",a.uploader=new e({url:"/api/v1/posts/image/uploader",autoUpload:!0,onSuccessItem:function(b,c){console.log(c),"success"===c.state?a.post.img=c.url:alert("上传错误")}}),a.tags=[],a.loadTags=function(){},a.addPost=function(){for(var b=a.post.tags,e=[],f=0,g=b.length;g>f;f++)e.push(b[f].text);var h={title:a.post.title,summary:a.post.summary,content:a.post.content,markdown:a.post.markdown,author:a.post.author,img:a.post.img,is_recommend:a.post.is_recommend,is_published:a.post.is_published,can_comment:a.post.can_comment,tag_list:e};c.createPost(h).success(function(a){console.log(a),"created"===a.status?d.path("/admin/posts").replace():alert("创建失败")}).error(function(a){console.log(a)})},a.logout=function(){h.logout()}}]),angular.module("ngblogApp").controller("PostEditCtrl",["$scope","postsService","$routeParams","$location","FileUploader","adminNavService",function(a,b,c,d,e,f){a.crumbs=[{anchor:"/#admin/posts",menu:"所有文章"},{anchor:"/#admin/posts/5",menu:"编辑文章"}],a.isCollapsed=!0,a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},b.getPostById(c.postId).success(function(b){a.post=b.post,a.post.is_recommend=1===a.post.is_recommend?!0:!1,a.post.is_published=1===a.post.is_published?!0:!1,a.post.can_comment=1===a.post.can_comment?!0:!1,a.markdown=function(a){return marked.setOptions({highlight:function(a){return hljs.highlightAuto(a).value}}),marked(a)};for(var c=[],d=a.post.tags,e=0,f=d.length;f>e;e++){var g={text:d[e].name};c.push(g)}a.post.tags=c}).error(function(a){console.log(a)}),a.updatePost=function(c){for(var e=a.post.tags,f=[],g=0,h=e.length;h>g;g++)console.log(e[g]),f.push(e[g].text);var i={id:c,title:a.post.title,summary:a.post.summary,content:a.post.content,markdown:a.post.markdown,author:a.post.author,img:a.post.img,is_recommend:a.post.is_recommend,is_published:a.post.is_published,can_comment:a.post.can_comment,tag_list:f};b.updatePost(i).success(function(a){console.log(a),"updated"===a.status?d.path("/admin/posts").replace():alert("更新失败")}).error(function(a){console.log(a)})},a.uploader=new e({url:"/api/v1/posts/image/uploader",autoUpload:!0,onSuccessItem:function(b,c){console.log(c),"success"===c.state?a.post.img=c.url:alert("上传错误")}}),a.logout=function(){f.logout()}}]),angular.module("ngblogApp").controller("PostShowCtrl",["$scope","$log","postsService","$routeParams","$controller",function(a,b,c,d,e){a.post=null,a.postimg=null,a.imageMark=!1,c.getPostById(d.postId).success(function(b){a.post=b.post,a.postimg=b.post.img,a.imageMark=null===a.postimg||""===a.postimg?!1:!0}).error(function(a){console.log(a)}),a.posts=[],c.getPosts(1,14,0).success(function(b){a.posts=b.data.posts,a.totalItems=b.data.total_count}).error(function(a){console.log(a)}),e("BaseCtrl",{$scope:a})}]),angular.module("ngblogApp").controller("SearchPostsCtrl",["$scope","postsService","$routeParams","$controller",function(a,b,c,d){a.keyword=c.keyword,a.messageMark=!0,b.searchPost(a.keyword).success(function(b){a.posts=b.posts,a.messageMark=null===a.posts||""===a.posts||0===a.posts.length?!1:!0}).error(function(a){console.log(a)}),d("BaseCtrl",{$scope:a})}]),angular.module("ngblogApp").controller("LoginCtrl",["$scope","AuthService","SessionService","$location",function(a,b,c,d){a.user={email:"",password:""},a.login=function(){var e={login:a.user};console.log(e),b.login(e).success(function(a){console.log(a),a.auth_token&&a.current_user?(alert("登陆成功"),c.setCurrentUser(a.current_user),c.setAuthToken(a.auth_token),d.path(c.backUrl||"/"),c.setBackUrl(null)):a.error&&alert("用户名或者密码错误, 请重新输入")}).error(function(a){console.log(a)})}}]),angular.module("ngblogApp").directive("ueditor",["$timeout",function(a){return{restrict:"AE",require:"?ngModel",link:function(b,c,d,e){if(e&&void 0!==UE){var f=UE.getEditor(c[0],{initialFrameWidth:"100%",initialFrameHeight:"300",autoHeightEnabled:!0}),g=function(){var c=f.getContent();return""===c?null:void(c!==e.$viewValue&&(b.$root.$$phase||a(function(){b.$apply(function(){e.$setViewValue(f.getContent())})},0)))};void 0!==f&&null!==f&&(f.addListener("ready",function(){e.$render=function(){f.setContent(e.$viewValue||"")}}),f.addListener("blur",g))}}}}]),angular.module("ngblogApp").directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter,{event:b})}),b.preventDefault())})}}),angular.module("ngblogApp").directive("ace",["$timeout",function(a){return{require:"?ngModel",link:function(b,c,d,e){var f=ace.edit(c[0]);f.setTheme("ace/theme/monokai"),f.getSession().setMode("ace/mode/markdown"),f.setShowPrintMargin(!1),f.setOptions({fontSize:"10pt"}),void 0!==f&&null!==f&&(e.$render=function(){f.setValue(e.$viewValue)},f.on("change",function(){a(function(){b.$apply(function(){e.$setViewValue(f.getValue())})},0)}))}}}]),angular.module("ngblogApp").directive("breadcrumbs",function(){return{restrict:"E",replace:!0,templateUrl:"views/directives/breadcrumbs.html"}}),angular.module("ngblogApp").directive("navmenu",function(){return{restrict:"E",replace:!0,templateUrl:"views/directives/nav.html"}}),angular.module("ngblogApp").factory("postsService",["$http",function(a){return{getPosts:function(b,c,d){b="undefined"!=typeof b?b:1,c="undefined"!=typeof c?c:20,d="undefined"!=typeof d?d:0;var e="?page="+b+"&per_page="+c+"&offset="+d;return a.get("/api/v1/posts"+e)},getPostById:function(b){return a.get("/api/v1/posts/"+b)},createPost:function(b){return a.post("/api/v1/posts",{post:b})},delPost:function(b){return a["delete"]("/api/v1/posts/"+b)},updatePost:function(b){return a.patch("/api/v1/posts/"+b.id,{post:b})},searchPost:function(b){return a.get("/api/v1/posts/search?keyword="+b)}}}]),angular.module("ngblogApp").factory("SessionService",["localStorageService",function(a){a.isSupported||alert("不支持localStorage");var b={currentUser:a.get("currentUser"),authToken:a.get("authToken"),backUrl:null,isLoggedIn:function(){return null!==b.currentUser?!0:!1},setCurrentUser:function(c){a.set("currentUser",c),b.currentUser=c},getCurrentUser:function(){return b.currentUser},setAuthToken:function(c){a.set("authToken",c),b.authToken=c},getAuthToken:function(){return b.authToken},setBackUrl:function(a){b.backUrl=a},getBackUrl:function(){return b.backUrl}};return b}]),angular.module("ngblogApp").factory("AuthService",["$http","SessionService","localStorageService",function(a,b,c){var d={};return d.login=function(b){return a.post("/api/v1/users/auth",b)},d.logout=function(){b.setCurrentUser(null),b.setAuthToken(null),c.remove("currentUser"),c.remove("authToken")},d}]),angular.module("ngblogApp").factory("adminNavService",["AuthService","$window",function(a,b){return{logout:function(){a.logout(),b.location.href="/"}}}]),angular.module("ngblogApp").factory("SessionInjector",["SessionService","$injector","$window",function(a,b,c){var d={request:function(c){return null!==a.authToken&&void 0!==a.authToken&&(b.get("$http").defaults.headers.common.Authorization=a.authToken),c},response:function(a){return a},responseError:function(a){return(401===a.status||418===a.status||419===a.status)&&(c.location.href="/#/login"),a}};return d}]),angular.module("ngblogApp").filter("postFilter",function(){return function(a){return"postFilter filter: "+a}});